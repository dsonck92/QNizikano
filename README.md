# QNizikano
Desktop version of the Android Nizikano (aka Dream Girlfriend) app (US version). Note that this app is *not* official and experience may vary depending on compatibility between the server and app emulation.

## About
Nizikano or "Dream Girlfriend" is an app where the user receives a girlfriend that he (or she) can customize to his (or her) liking. By performing various actions, she will receive experience, different personalities and unlock other clothing. It is considered a cute game to pass time.

This Qt program attempts to imitate the Android app for Nizikano or "Dream Girlfriend". It allows playing/accessing this game on PCs that Qt supports.

## Features

* General gameplay
* Event gameplay
* GF Chat
* Background Music
* Sound effects
* Voice data
* Export picture

## Not implemented

* Correct random User ID generation
* Live2D view

## How to build

This program uses Qt and requires QtWebKit in order to facilitate the browser part. Any Qt version starting from 4.6 will work. For sound playback SFML is necessary.

    # qmake
    # make

## Inner workings
The android app is a simple webapp that catches specific navigation requests to bridge it to Android.

This program uses QtWebKit as its webview replacement. The QWebView is subclassed to force a Height/Width ratio of 1.334 and inject touch events in addition to mouse events as the game pages expects TouchEvents to be generated by the browser. The QWebPage is subclassed to catch the special navigation requests that perform all non-browser tasks like playing the background music or showing the notifications.

In order to navigate around, the bottom bar calls the `footerFunc()` javascript function which handles page navigation. A few quick access buttons on the right bypass the javascript and navigate directly to the respective pages. This is very subject to change in the future as there is no guarantee this remains the same on the server. It is to be considered a hack reminiscent of the time I didn't realize the javascript does everything.

The android app identifies itself by a custom UserAgent. The user agent consists of a fixed text, a unique ID and a fixed ID at the end. The meaning of the fixed ID is currently unknown and the unique ID is not possible to be generated by the program. When the unique ID is the same as an android app unique ID, the account bound to the android app will be shared with the program. Little experimentation shows that "non-existent" IDs map to a special account. That is also the reason why generation of the ID is impossible: any invalid ID results in the same account so all random desktop IDs would go to the same account.

The program first navigates to the root of the server with the special UserAgent string. The root page will then issue a 302 to the room page and add a P= argument. This P= argument is stored and used for successive page navigation as this indicates the session ID. It is currently unknown whether the UserAgent IDs really need to be sent with each request. The android app does this but it seems like that defeats the purpose of the P= argument

Resource downloading is done by requesting a download list file. This returns a TSV file with [basename]\t[package-key]\t[number]. The [basename]s indicate which files can be found in what [package]. If the basename begins with bgm_, it means that the file is called as it is indicated. if it does not start with bgm_, it is considered a voice_ file. All files are .ogg files and each package is a zip file. If any file is missing, the corresponding package is downloaded and extracted in memory.

As of this day, not all resources are noted inside the TSV file. Most notably bgm_0[1-8] and all sound effect files se_01 - se_23. A script is provided to download these from the Japanese PC version.

After the app got to the current stage, I discovered that the Japanese version of the game offers a PC web version. It offers the same game in Japanese and is separate from the US version.

Currently, the Live2D View (aka Motion) requested by the app webpages is incompatible with the WebKit browser. I'm currently investigating whether it's possible to still use the Live2D View plugin by referencing it from the japanese version. Initial research seems to indicate it may require Chrome or Firefox to run and won't support WebKit. If this is the case, it might be necessary to migrate to WebEngine. The current reason why the app doesn't use QtWebEngine is because it's not possible to do the TouchEvent injection. QWebEngineView doesn't allow catching mouse events. Possible workarounds would involve "Chromiums generate TouchEvents by mouse" settings that are available in official Chromium browsers.
